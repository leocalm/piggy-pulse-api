---
kind: pipeline
type: docker
name: test

# Run tests on all branches
steps:
  - name: test
    image: rust:1.93
    volumes:
      - name: cargo-registry
        path: /usr/local/cargo/registry
      - name: cargo-git
        path: /usr/local/cargo/git
      - name: target
        path: /drone/src/target
    commands:
      - cargo --version
      - rustc --version
      - echo "Installing rustfmt and clippy..."
      - rustup component add rustfmt clippy
      - echo "Running format check..."
      - cargo fmt -- --check
      - echo "Running clippy..."
      - cargo clippy -- -D warnings
      - echo "Running tests..."
      - cargo test --all

volumes:
  - name: cargo-registry
    host:
      path: /tmp/drone-cargo-registry
  - name: cargo-git
    host:
      path: /tmp/drone-cargo-git
  - name: target
    host:
      path: /tmp/drone-target

---
kind: pipeline
type: docker
name: build-and-deploy

# Only run on main branch
trigger:
  branch:
    - main
  event:
    - push

steps:
  - name: build-api
    image: docker:dind
    volumes:
      - name: dockersock
        path: /var/run/docker.sock
    environment:
      GHCR_USERNAME:
        from_secret: ghcr_username
      GHCR_TOKEN:
        from_secret: ghcr_token​​​​​​​​​​​​​​​​
