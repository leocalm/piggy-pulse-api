version: 2.1

jobs:
  build_api:
    machine:
      image: ubuntu-2204:current
    steps:
      - checkout

      - run:
          name: Setup Docker Buildx
          command: |
            docker buildx create --use || true
            docker buildx inspect --bootstrap

      - run:
          name: Build and push API
          command: |
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin
            docker buildx build \
              --cache-from type=registry,ref=ghcr.io/leocalm/piggypulse-api:buildcache \
              --cache-to type=registry,ref=ghcr.io/leocalm/piggypulse-api:buildcache,mode=max \
              --tag ghcr.io/leocalm/piggypulse-api:latest \
              --push \
              .

  build_cron:
    machine:
      image: ubuntu-2204:current
    steps:
      - checkout

      - run:
          name: Setup Docker Buildx
          command: |
            docker buildx create --use || true
            docker buildx inspect --bootstrap

      - run:
          name: Build and push Cron
          command: |
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin
            docker buildx build \
              --cache-from type=registry,ref=ghcr.io/leocalm/piggypulse-cron:buildcache \
              --cache-to type=registry,ref=ghcr.io/leocalm/piggypulse-cron:buildcache,mode=max \
              --tag ghcr.io/leocalm/piggypulse-cron:latest \
              --file Dockerfile.cron \
              --push \
              .

  deploy:
    machine:
      image: ubuntu-2204:current
    steps:
      - run:
          name: Setup SSH
          command: |
            mkdir -p ~/.ssh
            echo "$HETZNER_SSH_KEY" > ~/.ssh/id_ed25519
            chmod 600 ~/.ssh/id_ed25519
            echo "$HETZNER_HOST_KEY" >> ~/.ssh/known_hosts

      - run:
          name: Deploy to Hetzner
          command: |
            ssh -i ~/.ssh/id_ed25519 $HETZNER_USER@$HETZNER_HOST '
              cd /opt/piggypulse/budget
              echo "ğŸ‹ Pulling latest images..."
              docker compose pull
              echo "ğŸš€ Starting services..."
              docker compose up -d
              echo "ğŸ§¹ Cleaning up old images..."
              docker image prune -af
              echo "âœ… Deploy complete!"
            '

workflows:
  build_and_deploy:
    jobs:
      - build_api:
          filters:
            branches:
              only: main

      - build_cron:
          filters:
            branches:
              only: main

      - deploy:
          requires:
            - build_api
            - build_cron
          filters:
            branches:
              only: main
