services:
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-budget_db}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-budget_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - budget_internal

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    command:
      - sh
      - -ec
      - |
        exec redis-server \
          --appendonly yes \
          --save 900 1 \
          --save 300 10 \
          --save 60 10000 \
          --maxmemory 256mb \
          --maxmemory-policy allkeys-lru \
          --requirepass "$${REDIS_PASSWORD}"
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:?REDIS_PASSWORD is required}
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD} ping | grep PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - budget_internal

  budget:
    image: ${BUDGET_API_IMAGE:?BUDGET_API_IMAGE is required}
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    entrypoint:
      - /bin/sh
      - -ec
      - |
        max_retries=30
        retry_count=0
        while [ "$retry_count" -lt "$max_retries" ]; do
          if sqlx migrate run --source /app/migrations 2>&1; then
            break
          fi
          retry_count=$((retry_count + 1))
          if [ "$retry_count" -lt "$max_retries" ]; then
            sleep 2
          else
            echo "ERROR: Database migrations failed after $max_retries attempts"
            exit 1
          fi
        done
        exec /app/budget
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD_URLENC:?POSTGRES_PASSWORD_URLENC is required}@db:5432/${POSTGRES_DB:-budget_db}
      BUDGET_DATABASE__URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD_URLENC:?POSTGRES_PASSWORD_URLENC is required}@db:5432/${POSTGRES_DB:-budget_db}
      BUDGET_DATABASE__MAX_CONNECTIONS: ${BUDGET_DATABASE_MAX_CONNECTIONS:-16}
      BUDGET_DATABASE__MIN_CONNECTIONS: ${BUDGET_DATABASE_MIN_CONNECTIONS:-4}
      BUDGET_DATABASE__CONNECTION_TIMEOUT: ${BUDGET_DATABASE_CONNECTION_TIMEOUT:-5}
      BUDGET_DATABASE__ACQUIRE_TIMEOUT: ${BUDGET_DATABASE_ACQUIRE_TIMEOUT:-5}

      BUDGET_SERVER__PORT: 8000
      BUDGET_SERVER__ADDRESS: 0.0.0.0
      ROCKET_PORT: 8000
      ROCKET_ADDRESS: 0.0.0.0
      ROCKET_SECRET_KEY: ${ROCKET_SECRET_KEY:?ROCKET_SECRET_KEY is required}

      BUDGET_API__BASE_PATH: /api/v1
      BUDGET_API__EXPOSE_DOCS: ${BUDGET_API_EXPOSE_DOCS:-false}

      BUDGET_CORS__ALLOWED_ORIGINS: "${BUDGET_CORS_ALLOWED_ORIGINS:?BUDGET_CORS_ALLOWED_ORIGINS is required}"
      BUDGET_CORS__ALLOW_CREDENTIALS: ${BUDGET_CORS_ALLOW_CREDENTIALS:-true}

      BUDGET_RATE_LIMIT__USE_FORWARDED_IP: "true"
      BUDGET_RATE_LIMIT__FORWARDED_IP_HEADER: x-forwarded-for
      BUDGET_RATE_LIMIT__BACKEND: redis
      BUDGET_RATE_LIMIT__REDIS_URL: "redis://:${REDIS_PASSWORD_URLENC:?REDIS_PASSWORD_URLENC is required}@redis:6379/0"
      BUDGET_RATE_LIMIT__REDIS_KEY_PREFIX: "budget:rate_limit:"

      BUDGET_LOGGING__LEVEL: ${BUDGET_LOGGING_LEVEL:-info}
      BUDGET_LOGGING__JSON_FORMAT: ${BUDGET_LOGGING_JSON_FORMAT:-true}

      BUDGET_EMAIL__ENABLED: ${BUDGET_EMAIL_ENABLED:-true}
      BUDGET_EMAIL__SMTP_HOST: ${BUDGET_EMAIL_SMTP_HOST:?BUDGET_EMAIL_SMTP_HOST is required}
      BUDGET_EMAIL__SMTP_PORT: ${BUDGET_EMAIL_SMTP_PORT:-587}
      BUDGET_EMAIL__SMTP_USERNAME: ${BUDGET_EMAIL_SMTP_USERNAME:?BUDGET_EMAIL_SMTP_USERNAME is required}
      BUDGET_EMAIL__SMTP_PASSWORD: ${BUDGET_EMAIL_SMTP_PASSWORD:?BUDGET_EMAIL_SMTP_PASSWORD is required}
      BUDGET_EMAIL__FROM_ADDRESS: ${BUDGET_EMAIL_FROM_ADDRESS:-noreply@piggy-pulse.com}
      BUDGET_EMAIL__FROM_NAME: ${BUDGET_EMAIL_FROM_NAME:-PiggyPulse}

      BUDGET_PASSWORD_RESET__FRONTEND_RESET_URL: ${BUDGET_PASSWORD_RESET_FRONTEND_RESET_URL:?BUDGET_PASSWORD_RESET_FRONTEND_RESET_URL is required}
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/api/v1/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    networks:
      - budget_internal

  cron:
    image: ${BUDGET_CRON_IMAGE:?BUDGET_CRON_IMAGE is required}
    restart: unless-stopped
    depends_on:
      budget:
        condition: service_healthy
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=32m
    environment:
      CRON_SCHEDULE: ${CRON_SCHEDULE:-*/15 * * * *}
      BUDGET_DATABASE__URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD_URLENC:?POSTGRES_PASSWORD_URLENC is required}@db:5432/${POSTGRES_DB:-budget_db}
      BUDGET_DATABASE__MAX_CONNECTIONS: ${BUDGET_DATABASE_MAX_CONNECTIONS:-8}
      BUDGET_DATABASE__MIN_CONNECTIONS: ${BUDGET_DATABASE_MIN_CONNECTIONS:-2}
      BUDGET_DATABASE__CONNECTION_TIMEOUT: ${BUDGET_DATABASE_CONNECTION_TIMEOUT:-5}
      BUDGET_DATABASE__ACQUIRE_TIMEOUT: ${BUDGET_DATABASE_ACQUIRE_TIMEOUT:-5}
      BUDGET_LOGGING__LEVEL: ${BUDGET_LOGGING_LEVEL:-info}
      BUDGET_LOGGING__JSON_FORMAT: ${BUDGET_LOGGING_JSON_FORMAT:-true}
    networks:
      - budget_internal

  caddy:
    image: caddy:2.8-alpine
    restart: unless-stopped
    depends_on:
      budget:
        condition: service_healthy
    security_opt:
      - no-new-privileges:true
    ports:
      - "443:443/tcp"
      - "443:443/udp"
    environment:
      CADDY_DOMAIN: ${CADDY_DOMAIN:?CADDY_DOMAIN is required}
      CADDY_ACME_EMAIL: ${CADDY_ACME_EMAIL:-security@piggy-pulse.com}
      CADDY_LOG_LEVEL: ${CADDY_LOG_LEVEL:-INFO}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - budget_internal

networks:
  budget_internal:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  caddy_data:
  caddy_config:
