services:
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-piggy-pulse_db}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-piggy-pulse_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - piggy-pulse_internal

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    command:
      - sh
      - -ec
      - |
        exec redis-server \
          --appendonly yes \
          --save 900 1 \
          --save 300 10 \
          --save 60 10000 \
          --maxmemory 256mb \
          --maxmemory-policy allkeys-lru \
          --requirepass "$${REDIS_PASSWORD}"
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:?REDIS_PASSWORD is required}
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD} ping | grep PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - piggy-pulse_internal

  piggy-pulse:
    image: ${PIGGY_PULSE_API_IMAGE:?PIGGY_PULSE_API_IMAGE is required}
    platform: ${PIGGY_PULSE_IMAGE_PLATFORM:-linux/amd64}
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=64m
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD_URLENC:?POSTGRES_PASSWORD_URLENC is required}@db:5432/${POSTGRES_DB:-piggy-pulse_db}
      PIGGY_PULSE_DATABASE__URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD_URLENC:?POSTGRES_PASSWORD_URLENC is required}@db:5432/${POSTGRES_DB:-piggy-pulse_db}
      PIGGY_PULSE_DATABASE__MAX_CONNECTIONS: ${PIGGY_PULSE_DATABASE_MAX_CONNECTIONS:-16}
      PIGGY_PULSE_DATABASE__MIN_CONNECTIONS: ${PIGGY_PULSE_DATABASE_MIN_CONNECTIONS:-4}
      PIGGY_PULSE_DATABASE__CONNECTION_TIMEOUT: ${PIGGY_PULSE_DATABASE_CONNECTION_TIMEOUT:-5}
      PIGGY_PULSE_DATABASE__ACQUIRE_TIMEOUT: ${PIGGY_PULSE_DATABASE_ACQUIRE_TIMEOUT:-5}

      PIGGY_PULSE_SERVER__PORT: 8000
      PIGGY_PULSE_SERVER__ADDRESS: 0.0.0.0
      ROCKET_PORT: 8000
      ROCKET_ADDRESS: 0.0.0.0
      ROCKET_SECRET_KEY: ${ROCKET_SECRET_KEY:?ROCKET_SECRET_KEY is required}

      PIGGY_PULSE_API__BASE_PATH: /api/v1
      PIGGY_PULSE_API__EXPOSE_DOCS: ${PIGGY_PULSE_API_EXPOSE_DOCS:-false}

      PIGGY_PULSE_CORS__ALLOWED_ORIGINS: "${PIGGY_PULSE_CORS_ALLOWED_ORIGINS:?PIGGY_PULSE_CORS_ALLOWED_ORIGINS is required}"
      PIGGY_PULSE_CORS__ALLOW_CREDENTIALS: ${PIGGY_PULSE_CORS_ALLOW_CREDENTIALS:-true}

      PIGGY_PULSE_RATE_LIMIT__USE_FORWARDED_IP: "true"
      PIGGY_PULSE_RATE_LIMIT__FORWARDED_IP_HEADER: x-forwarded-for
      PIGGY_PULSE_RATE_LIMIT__BACKEND: redis
      PIGGY_PULSE_RATE_LIMIT__REDIS_URL: "redis://:${REDIS_PASSWORD_URLENC:?REDIS_PASSWORD_URLENC is required}@redis:6379/0"
      PIGGY_PULSE_RATE_LIMIT__REDIS_KEY_PREFIX: "piggy-pulse:rate_limit:"

      PIGGY_PULSE_LOGGING__LEVEL: ${PIGGY_PULSE_LOGGING_LEVEL:-info}
      PIGGY_PULSE_LOGGING__JSON_FORMAT: ${PIGGY_PULSE_LOGGING_JSON_FORMAT:-true}

      PIGGY_PULSE_EMAIL__ENABLED: ${PIGGY_PULSE_EMAIL_ENABLED:-true}
      PIGGY_PULSE_EMAIL__SMTP_HOST: ${PIGGY_PULSE_EMAIL_SMTP_HOST:?PIGGY_PULSE_EMAIL_SMTP_HOST is required}
      PIGGY_PULSE_EMAIL__SMTP_PORT: ${PIGGY_PULSE_EMAIL_SMTP_PORT:-587}
      PIGGY_PULSE_EMAIL__SMTP_USERNAME: ${PIGGY_PULSE_EMAIL_SMTP_USERNAME:?PIGGY_PULSE_EMAIL_SMTP_USERNAME is required}
      PIGGY_PULSE_EMAIL__SMTP_PASSWORD: ${PIGGY_PULSE_EMAIL_SMTP_PASSWORD:?PIGGY_PULSE_EMAIL_SMTP_PASSWORD is required}
      PIGGY_PULSE_EMAIL__FROM_ADDRESS: ${PIGGY_PULSE_EMAIL_FROM_ADDRESS:-noreply@piggy-pulse.com}
      PIGGY_PULSE_EMAIL__FROM_NAME: ${PIGGY_PULSE_EMAIL_FROM_NAME:-PiggyPulse}

      PIGGY_PULSE_PASSWORD_RESET__FRONTEND_RESET_URL: ${PIGGY_PULSE_PASSWORD_RESET_FRONTEND_RESET_URL:?PIGGY_PULSE_PASSWORD_RESET_FRONTEND_RESET_URL is required}
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/api/v1/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    networks:
      - piggy-pulse_internal

  cron:
    image: ${PIGGY_PULSE_CRON_IMAGE:?PIGGY_PULSE_CRON_IMAGE is required}
    platform: ${PIGGY_PULSE_IMAGE_PLATFORM:-linux/amd64}
    restart: unless-stopped
    depends_on:
      piggy-pulse:
        condition: service_healthy
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=32m
    environment:
      CRON_SCHEDULE: ${CRON_SCHEDULE:-*/15 * * * *}
      PIGGY_PULSE_DATABASE__URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD_URLENC:?POSTGRES_PASSWORD_URLENC is required}@db:5432/${POSTGRES_DB:-piggy-pulse_db}
      PIGGY_PULSE_DATABASE__MAX_CONNECTIONS: ${PIGGY_PULSE_DATABASE_MAX_CONNECTIONS:-8}
      PIGGY_PULSE_DATABASE__MIN_CONNECTIONS: ${PIGGY_PULSE_DATABASE_MIN_CONNECTIONS:-2}
      PIGGY_PULSE_DATABASE__CONNECTION_TIMEOUT: ${PIGGY_PULSE_DATABASE_CONNECTION_TIMEOUT:-5}
      PIGGY_PULSE_DATABASE__ACQUIRE_TIMEOUT: ${PIGGY_PULSE_DATABASE_ACQUIRE_TIMEOUT:-5}
      PIGGY_PULSE_LOGGING__LEVEL: ${PIGGY_PULSE_LOGGING_LEVEL:-info}
      PIGGY_PULSE_LOGGING__JSON_FORMAT: ${PIGGY_PULSE_LOGGING_JSON_FORMAT:-true}
    networks:
      - piggy-pulse_internal

  caddy:
    image: caddy:2.8-alpine
    restart: unless-stopped
    depends_on:
      piggy-pulse:
        condition: service_healthy
    security_opt:
      - no-new-privileges:true
    ports:
      - "443:443/tcp"
      - "443:443/udp"
    environment:
      CADDY_DOMAIN: ${CADDY_DOMAIN:?CADDY_DOMAIN is required}
      CADDY_ACME_EMAIL: ${CADDY_ACME_EMAIL:-security@piggy-pulse.com}
      CADDY_LOG_LEVEL: ${CADDY_LOG_LEVEL:-INFO}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - piggy-pulse_internal

networks:
  piggy-pulse_internal:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  caddy_data:
  caddy_config:
