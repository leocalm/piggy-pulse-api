# Production Deployment (Single VM)

This stack runs on one host:
- `caddy` (public 443)
- `budget` API (internal only)
- `cron` worker (internal only)
- `postgres` (internal only)
- `redis` (internal only)

## 1) Prepare Host

Provision the server with `infra/hetzner` first, then run Ansible from `ansible/` to harden host and deploy.

## 2) Copy Environment

```bash
cd /opt/piggypulse/budget/deploy/production
cp .env.example .env
```

Set all secret values in `.env`, including:
- `BUDGET_API_IMAGE` (GHCR digest reference)
- `BUDGET_CRON_IMAGE` (GHCR digest reference)
- `BUDGET_IMAGE_PLATFORM` (set to `linux/amd64` for Hetzner x86 servers)
- get both from `image-digests.env` in the `image-digests` artifact generated by the `Publish Container Images` workflow

If you use Ansible (`ansible/`), `.env` is generated from Vault automatically and you can skip this manual step.

## 3) Start Services

```bash
docker compose pull
docker compose up -d --remove-orphans
```

## 4) Verify Exposure

Only expected public listeners should exist:

```bash
ss -lntup
```

Expected:
- `:443` for caddy
- `:51820/udp` for WireGuard (if enabled)
- no public `:5432`, `:6379`, `:8000`

## 5) Health Checks

```bash
curl -I https://api.piggy-pulse.com/api/v1/health

docker compose ps
docker compose logs --tail=200 budget
```

## 6) Persistence via systemd

Ansible installs `piggypulse-stack.service`:

```bash
sudo systemctl enable piggypulse-stack.service
sudo systemctl start piggypulse-stack.service
sudo systemctl status piggypulse-stack.service
```

## 7) Mandatory Security Checks

- `BUDGET_API_EXPOSE_DOCS=false`
- CORS only `https://piggy-pulse.com`
- strong `ROCKET_SECRET_KEY`
- strong DB/Redis passwords
- Cloudflare SSL mode set to `Full (strict)`
- backups tested with restore procedure

## Update Procedure

```bash
cd /opt/piggypulse/budget
git fetch --all
git checkout <release-tag-or-commit>
cd deploy/production
docker compose pull
docker compose up -d --remove-orphans
```
