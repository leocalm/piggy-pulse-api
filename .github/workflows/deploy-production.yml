name: Deploy Production

on:
  workflow_run:
    workflows: ["Publish Container Images"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      piggypulse_api_image:
        description: "Immutable API image ref (ghcr.io/...@sha256:...)"
        required: true
        type: string
      piggypulse_cron_image:
        description: "Immutable Cron image ref (ghcr.io/...@sha256:...)"
        required: true
        type: string

permissions:
  contents: read
  actions: read

concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: Run Ansible production deploy
    runs-on: ubuntu-latest
    environment: production
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download image digest artifact from publish run
        if: ${{ github.event_name == 'workflow_run' }}
        uses: actions/download-artifact@v4
        with:
          name: image-digests
          path: image-digests
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Materialize deploy image vars file
        env:
          EVENT_NAME: ${{ github.event_name }}
          MANUAL_API_IMAGE: ${{ inputs.piggypulse_api_image }}
          MANUAL_CRON_IMAGE: ${{ inputs.piggypulse_cron_image }}
        run: |
          set -euo pipefail
          if [ "${EVENT_NAME}" = "workflow_dispatch" ]; then
            printf 'piggypulse_api_image: %s\n' "${MANUAL_API_IMAGE}" > ansible-image-vars.yml
            printf 'piggypulse_cron_image: %s\n' "${MANUAL_CRON_IMAGE}" >> ansible-image-vars.yml
          else
            test -f image-digests/ansible-image-vars.yml
            cp image-digests/ansible-image-vars.yml ansible-image-vars.yml
          fi

      - name: Validate required deploy files and secrets
        run: |
          test -f ansible-image-vars.yml
          grep -Eq '^[[:space:]]*piggypulse_api_image:[[:space:]]*.+$' ansible-image-vars.yml
          grep -Eq '^[[:space:]]*piggypulse_cron_image:[[:space:]]*.+$' ansible-image-vars.yml
          echo "Using ansible-image-vars.yml:"
          cat ansible-image-vars.yml
          test -n "${{ secrets.ANSIBLE_VAULT_PASSWORD }}"
          test -n "${{ secrets.PROD_WIREGUARD_CONFIG }}"
          test -n "${{ secrets.PROD_SSH_KNOWN_HOSTS }}"

      - name: Normalize deploy image vars for Ansible
        run: |
          set -euo pipefail
          api_image="$(sed -n 's/^[[:space:]]*piggypulse_api_image:[[:space:]]*//p' ansible-image-vars.yml | head -n1 | tr -d '\r' | xargs)"
          cron_image="$(sed -n 's/^[[:space:]]*piggypulse_cron_image:[[:space:]]*//p' ansible-image-vars.yml | head -n1 | tr -d '\r' | xargs)"
          api_image="${api_image%\"}"
          api_image="${api_image#\"}"
          api_image="${api_image%\'}"
          api_image="${api_image#\'}"
          cron_image="${cron_image%\"}"
          cron_image="${cron_image#\"}"
          cron_image="${cron_image%\'}"
          cron_image="${cron_image#\'}"
          test -n "${api_image}"
          test -n "${cron_image}"
          case "${api_image}" in
            ghcr.io/*) ;;
            *) echo "Invalid piggypulse_api_image: ${api_image}" >&2; exit 1 ;;
          esac
          case "${cron_image}" in
            ghcr.io/*) ;;
            *) echo "Invalid piggypulse_cron_image: ${cron_image}" >&2; exit 1 ;;
          esac
          printf 'PIGGYPULSE_API_IMAGE=%s\n' "${api_image}" >> "${GITHUB_ENV}"
          printf 'PIGGYPULSE_CRON_IMAGE=%s\n' "${cron_image}" >> "${GITHUB_ENV}"

      - name: Install Ansible and WireGuard tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible wireguard-tools

      - name: Configure and start WireGuard
        run: |
          sudo install -d -m 0700 /etc/wireguard
          printf '%s\n' "${{ secrets.PROD_WIREGUARD_CONFIG }}" | sudo tee /etc/wireguard/wg0.conf > /dev/null
          sudo chmod 600 /etc/wireguard/wg0.conf
          sudo wg-quick up wg0
          sudo wg show

      - name: Verify VPN connectivity to production host
        run: |
          ping -c 3 10.66.0.1

      - name: Prepare SSH known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "${{ secrets.PROD_SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Optionally install deploy SSH key from secret
        env:
          PROD_SSH_PRIVATE_KEY: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          PROD_SSH_PRIVATE_KEY_B64: ${{ secrets.PROD_SSH_PRIVATE_KEY_B64 }}
        run: |
          if [ -n "${PROD_SSH_PRIVATE_KEY_B64:-}" ] || [ -n "${PROD_SSH_PRIVATE_KEY:-}" ]; then
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            if [ -n "${PROD_SSH_PRIVATE_KEY_B64:-}" ]; then
              printf '%s' "${PROD_SSH_PRIVATE_KEY_B64}" | tr -d '[:space:]' | base64 -d > ~/.ssh/id_ed25519
            else
              # Support secrets copied with escaped newlines and strip CRLF.
              printf '%b' "${PROD_SSH_PRIVATE_KEY}" | tr -d '\r' > ~/.ssh/id_ed25519
            fi
            chmod 600 ~/.ssh/id_ed25519
            ssh-keygen -y -f ~/.ssh/id_ed25519 >/dev/null
          fi

      - name: Write vault password file
        run: |
          printf '%s' "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > .vault_pass
          chmod 600 .vault_pass

      - name: Verify Ansible is installed on runner
        run: |
          ansible --version
          ansible-playbook --version

      - name: Run Ansible deploy
        env:
          ANSIBLE_CONFIG: ansible/ansible.cfg
          ANSIBLE_VAULT_IDENTITY_LIST: prod@.vault_pass,default@.vault_pass
          PIGGYPULSE_API_IMAGE: ${{ env.PIGGYPULSE_API_IMAGE }}
          PIGGYPULSE_CRON_IMAGE: ${{ env.PIGGYPULSE_CRON_IMAGE }}
        run: |
          ansible-playbook ansible/site.yml \
            --vault-id prod@.vault_pass \
            --vault-id default@.vault_pass \
            --extra-vars "piggypulse_api_image=${PIGGYPULSE_API_IMAGE}" \
            --extra-vars "piggypulse_cron_image=${PIGGYPULSE_CRON_IMAGE}"

      - name: Cleanup sensitive temp files
        if: always()
        run: |
          rm -f .vault_pass
          sudo wg-quick down wg0 || true
          sudo rm -f /etc/wireguard/wg0.conf
